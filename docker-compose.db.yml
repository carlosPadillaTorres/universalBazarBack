services:
  database_univesal_bazar:
    image: mongo:latest
    container_name: mongo-univesal-bazar
    environment:  
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}
      MONGO_LOG_LEVEL: "warning" 
    command: ["mongod", "--quiet"]
    ports:
      - "${PORT_DB_HOST}:${PORT_DB_DOCKER}"
    volumes:
      - database_bazar_data:/data/db
    networks:
      - app_net

    healthcheck:
      # No se indica la base de datos porque si no existe, la crea
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok"]
      interval: 20s
      timeout: 10s
      retries: 30
      start_period: 15s

  mongo-express:
    image: mongo-express
    container_name: mongo-express-univesal-bazar
    restart: always
    ports:
      - ${CLIENT_MONGO_HOST_PORT}:8081
    environment:
      # Cliente mogno accesible a trav√©s de la URL: http://localhost:${CLIENT_MONGO_HOST_PORT}
      ME_CONFIG_MONGODB_URL: ${DATABASE_URL}
      ME_CONFIG_BASICAUTH_ENABLED: true
      ME_CONFIG_BASICAUTH_USERNAME: ${BASICAUTH_USERNAME_CLIENT_MONGO}
      ME_CONFIG_BASICAUTH_PASSWORD: ${BASICAUTH_PASSWORD_CLIENT_MONGO}
    networks:
      - app_net

  init-db:
    image: mongo
    depends_on:
      database_univesal_bazar:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts
    working_dir: /scripts
    environment:
      DATABASE_URL: ${DATABASE_URL}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}
    entrypoint: ["/bin/bash", "-c", "./init-products-data.sh"]
    networks:
      - app_net

networks:
  app_net:
    name: ${NETWORK_NAME}
    external: true

volumes:
  database_bazar_data: